#:kivy 1.0

### device management 
#:import ListHelioStatsIp device_mange.listHelioStatsIp.ListHelioStatsIp
#:import ListCameraIp device_mange.listCameraIp.ListCameraIp
#:import Description device_mange.description.Description
#:import UploadConnectionPage device_mange.uploadConnectionPage.UploadConnectionPage

### Camera control
#:import SetAutoScreen camera_control.auto_screen_widget.SetAutoScreen
#:import ManualScreen camera_control.manual_screen_widget.ManualScreen

### command 
#:import ControllerManual command.manual_command.ControllerManual
#:import ControllerAuto command.auto_command.ControllerAuto

### animation 
#:import BlinkSpot animation.blinking.BlinkSpot


MainFrameWidget: 

<MainFrameWidget>:
    LabHeaderWidget:

<ControllerManual>:
    orientation: 'vertical'
    # size_hint_y: .5
    # Label:
    #     id: return_value
    #     text: "Return: "
    #     bold: True
    #     size_hint_y: .2
    GridLayout:
        cols: 3
        spacing: 5
        GridLayout:
            rows: 3
            GridLayout:
                cols: 3
                Button:
                    # background_normal: "./images/t-l.png"
                    text:"Upper-L"
                    on_press: root.push_left_up()
                Button:
                    text: 'Upper'
                    on_press: root.push_upper()
                Button:
                    text:"Upper_R"
                    on_press: root.push_right_up()
            GridLayout:
                cols: 3
                Button:
                    text: 'left'
                    on_press: root.push_left()
                Button:
                    text:"stop"
                    on_press: root.haddle_stop()
                Button:
                    text:'right'
                    on_press: root.push_right()
            GridLayout:
                cols: 3
                Button:
                    text:"Down-L"
                    on_press: root.push_left_down()
                Button:
                    text: 'Down'
                    on_press: root.push_down()
                Button:
                    text:"Down_R"
                    on_press: root.push_right_down()
        Button:
            text: 'Capture'
            size_hint_x: .35
            on_press: root.update_and_submit()
        Button:
            text: 'Send data '
            size_hint_x: .35
            on_press: root.test_manual_send_payload_auto_2()



<ManualScreen>:
    BoxLayout:
        orientation: 'vertical'
        padding: 5
        spacing: 5

        # Camera status label
        BoxLayout:
            orientation: 'vertical'
            size_hint_y: .05
            Label:
                id: camera_status
                text: 'Manual menu || Camera status: Off'
                bold: True

        # Camera control buttons
        GridLayout:
            cols: 3
            size_hint_y: .1
            spacing: 5
            padding: 5

            Button:
                text: 'Stop Camera'
                background_color: (.4, .4, .4, 1)
                on_press: root.call_close_camera()

            Button:
                text: 'Start Camera'
                background_color: (.4, .4, .4, 1)
                on_press: root.call_open_camera()

            Button:
                text: "Cancel Crop"
                background_color: (.4, .4, .4, 1)
                on_press: root.reset_selection()
        
        GridLayout:
            cols: 3
            size_hint_y: .1
            canvas:
                Color:
                    rgba: .2, .2, .2, 1
                Rectangle:
                    pos: self.pos
                    size: self.size
            Label:
                text: 'Light center detected'
                bold: True
            Label:
                id: number_of_center_light_detected
                text: 'None'
                bold: True
            Label:
                id: description_of_center_light_count
                text: 'Description:'
                bold: True

        # Area for camera image and cropping interaction
        GridLayout:
            cols: 2
            BoxLayout:
                orientation: 'vertical'
                size_hint_y: .6
                canvas:
                    Color:
                        rgba: 1, 1, 1, 1
                    Rectangle:
                        pos: self.pos
                        size: self.size
                Image:
                    id: manual_cam_image
                    source: 'images/sample_image_2.png'  # Initial image
                    allow_stretch: True
                    keep_ratio: True
                    on_touch_down: None
                    on_touch_move: None
                    on_touch_up: None

            BoxLayout:
                orientation: 'vertical'
                size_hint_y: .6
                canvas:
                    Color:
                        rgba: 1, 1, 1, 1
                    Rectangle:
                        pos: self.pos
                        size: self.size
                Image:
                    id: manual_cam_image_demo
                    source: 'images/sample_image_2.png'  # Initial image
                    allow_stretch: True
                    keep_ratio: True
                    on_touch_down: None
                    on_touch_move: None
                    on_touch_up: None
        
        # Information and controls
        BoxLayout:
            orientation: 'vertical'
            size_hint_y: 0.1
            GridLayout:
                cols: 5
                GridLayout:
                    cols: 4
                    size_hint_x: .5
                    Label:
                        text: 'Threshold V'
                    Slider:
                        id: slider_hsv_low_v
                        min: 0
                        max: 255
                        step: 1
                        orientation: 'horizontal'
                        value:0
                        on_value: root.haddle_change_hsv_threshold(self.value)
                    Label:
                        id: slider_hsv_low_v_label
                        text: str(slider_hsv_low_v.value)
                    Button:
                        text: "Reset low_v"
                        on_press: root.haddle_reset_default_threshold_low_v()

                GridLayout:
                    rows: 2
                    size_hint_x: .4
                    GridLayout:
                        cols: 3
                        Label:
                            text:"Step machine"
                        TextInput:
                            id: set_step_machine
                            text: "Step machine"
                        Button:
                            id: btn_change_step_machine
                            text: "update"
                            on_press: root.haddle_change_step_machine()
                    GridLayout:
                        cols: 3
                        Label:
                            text:"Speed machine"
                        TextInput:
                            id: set_speed_machine
                            text: "Speed machine"
                        Button:
                            id: btn_change_step_machine
                            text: "update"
                            on_press: root.haddle_change_speed_machine()
                Button:
                    size_hint_x: .15
                    text: 'Reset threshold'
                    on_press: root.haddle_reset_default_threshold()
                Button: 
                    size_hint_x: .1
                    text: 'OriginX'
                    on_press: root.haddle_origin_x()
                Button:
                    size_hint_x: .1
                    text: 'OriginY'
                    on_press: root.haddle_origin_y()
        BoxLayout:
            orientation: 'horizontal'
            size_hint_y: .25
            spacing: 5
            canvas.before:
                Color:
                    rgba: .35, .35, .35, .35
                Rectangle:
                    pos: self.pos
                    size: self.size
            # Left side: Information labels
            GridLayout:
                cols: 1
                spacing: 1

                GridLayout:
                    cols: 2
                    size_hint_y: None
                    height: '30dp'

                    Label:
                        text: 'Center Target'
                        bold: True
                        font_size: 20

                    Label:
                        id: manual_center_target_position
                        text: 'Null'
                        bold: True
                        font_size: 20

                GridLayout:
                    cols: 2
                    size_hint_y: None
                    height: '30dp'

                    Label:
                        text: 'Center Frame'
                        bold: True
                        font_size: 20

                    Label:
                        id: manual_center_frame_position
                        text: 'Null'
                        bold: True
                        font_size: 20

                GridLayout:
                    cols: 2
                    size_hint_y: None
                    height: '30dp'

                    Label:
                        text: 'Error Center'
                        bold: True
                        font_size: 20

                    Label:
                        id: manual_error_center
                        text: 'Null'
                        bold: True
                        font_size: 20

                GridLayout:
                    cols: 2
                    size_hint_y: None
                    height: '30dp'

                    Label:
                        text: 'Bounding Frame'
                        bold: True
                        font_size: 20

                    Label:
                        id: manual_bounding_frame_position
                        text: 'Null'
                        bold: True
                        font_size: 20
                GridLayout:
                    cols: 2
                    size_hint_y: None
                    height: '30dp'
                    Label:
                        text: 'Using Crop'
                        bold: True
                        font_size: 20
                    Label:
                        id: using_crop_value_status
                        text: "Using Crop: Off"
                        bold: True
                        font_size: 20

            # Right side: Control buttons __recheck_perspective_transform
            GridLayout:
                cols: 5
                spacing: 5
                GridLayout:
                    rows: 2
                    Label:
                        id: selected_label_camera
                        text: "None"
                    Spinner:
                        id: spinner_camera
                        text: 'Select Camera'
                        size_hint: None, None
                        size: 200, 44
                        pos_hint: {'center_x': 0.5}
                        on_text: root.select_drop_down_menu_camera(self, self.text)
                GridLayout:
                    rows: 2
                    Label:
                        id: selected_label_helio_stats
                        text: "None"
                    Spinner:
                        id: spinner_helio_stats
                        text: 'Select helio'
                        size_hint: None, None
                        size: 200, 44
                        pos_hint: {'center_x': 0.5}
                        on_text: root.select_drop_down_menu_helio_stats(self, self.text)
                Button:
                    text: 'Reset Crop'
                    on_press: root.reset_crop_value()
                    background_color: (.4, .4, .4, 1)

                Button:
                    text: "Save Crop"
                    on_press: root.save_crop_value_image()
                    background_color: (.4, .4, .4, 1)

                Button:
                    text: 'Crop Mode'
                    on_press: root.active_crop_value()
                    background_color: (.4, .4, .4, 1)

            ControllerManual:
                id: controller_manual
                camera_is_open: camera_status
                error_center_f: manual_center_frame_position
                error_center_t: manual_center_target_position
                helio_stats_id_manual: selected_label_helio_stats
                camera_url_id_manual: selected_label_camera
                number_center_light: number_of_center_light_detected
                test_manual_send_payload_auto: manual_bounding_frame_position
                

<SetAutoScreen>:
    BoxLayout:
        orientation: 'vertical'
        padding: 5
        spacing: 5

        # Camera status label
        BoxLayout:
            orientation: 'vertical'
            size_hint_y: .09
            Label:
                id: auto_camera_status
                text: 'Auto menu || Camera status: Off'
                bold: True
            NavigationLayout:
                ScreenManager:
    
            Screen:

                BoxLayout:
                    orientation: 'vertical'

                    MDToolbar:
                        title: "Navigation Drawer"
                        elevation: 10
                        left_action_items: [['menu', lambda x: nav_drawer.toggle_nav_drawer()]]
                        
            MDNavigationDrawer:

        # Camera control buttons
        GridLayout:
            cols: 3
            size_hint_y: .1
            spacing: 5
            padding: 5

            Button:
                text: 'Stop Camera'
                background_color: (.4, .4, .4, 1)
                on_press: root.call_close_camera()

            Button:
                text: 'Start Camera'
                background_color: (.4, .4, .4, 1)
                on_press: root.call_open_camera()

            Button:
                text: "Cancel Crop"
                background_color: (.4, .4, .4, 1)
                on_press: root.reset_selection()
        GridLayout:
            cols: 3
            size_hint_y: .1
            canvas:
                Color:
                    rgba: .2, .2, .2, 1
                Rectangle:
                    pos: self.pos
                    size: self.size
            Label:
                text: 'Light center detected'
                bold: True
            Label:
                id: number_of_center_light_detected
                text: 'None'
                bold: True
            Label:
                id: description_of_center_light_count
                text: 'Description:'
                bold: True

        GridLayout:
            cols:2
            # Area for camera image and cropping interaction
            BoxLayout:
                orientation: 'vertical'
                size_hint_y: .6
                canvas:
                    Color:
                        rgba: 1, 1, 1, 1
                    Rectangle:
                        pos: self.pos
                        size: self.size
                Image:
                    id: auto_cam_image
                    source: 'images/sample_image_2.png'  # Initial image
                    allow_stretch: True
                    keep_ratio: True
                    on_touch_down: None
                    on_touch_move: None
                    on_touch_up: None
            
            BoxLayout:
                orientation: 'vertical'
                size_hint_y: .6
                canvas:
                    Color:
                        rgba: 1, 1, 1, 1
                    Rectangle:
                        pos: self.pos
                        size: self.size
                Image:
                    id: auto_cam_image_demo
                    source: 'images/sample_image_2.png'  # Initial image
                    allow_stretch: True
                    keep_ratio: True
                    on_touch_down: None
                    on_touch_move: None
                    on_touch_up: None


        # Information and controls
        BoxLayout:
            orientation: 'vertical'
            size_hint_y: 0.1
            GridLayout:
                cols: 3
                GridLayout:
                    cols: 4
                    Label:
                        text: 'Threshold V'
                    Slider:
                        id: slider_hsv_low_v
                        min: 0
                        max: 255
                        step: 1
                        orientation: 'horizontal'
                        value:0
                        on_value: root.haddle_change_hsv_threshold(self.value)
                    Label:
                        id: slider_hsv_low_v_label
                        text: str(slider_hsv_low_v.value)
                    Button:
                        text: "Reset low_v"
                        on_press: root.haddle_reset_default_threshold_low_v()

                GridLayout:
                    rows: 1
                    # GridLayout:
                    #     cols: 3
                    #     Label:
                    #         text:"Step machine"
                    #     TextInput:
                    #         id: set_step_machine
                    #         text: "Step machine"
                    #     Button:
                    #         id: btn_change_step_machine
                    #         text: "update"
                    #         on_press: root.haddle_change_step_machine()
                    GridLayout:
                        cols: 3
                        Label:
                            text:"Speed machine"
                        TextInput:
                            id: set_speed_machine
                            text: "Speed machine"
                        Button:
                            id: btn_change_step_machine
                            text: "update"
                            on_press: root.haddle_change_speed_machine()
                Button:
                    size_hint_x: .15
                    text: 'Reset threshold'
                    on_press: root.haddle_reset_default_threshold()

        GridLayout:
            cols: 5
            size_hint_y: .25
            spacing: 5

            # Left side: Information labels
            GridLayout:
                cols: 1
                spacing: 1

                GridLayout:
                    cols: 2
                    size_hint_y: None
                    height: '30dp'

                    Label:
                        text: 'Center Target'
                        bold: True
                        font_size: 20

                    Label:
                        id: auto_center_target_position
                        text: 'Null'
                        bold: True
                        font_size: 20

                GridLayout:
                    cols: 2
                    size_hint_y: None
                    height: '30dp'

                    Label:
                        text: 'Center Frame'
                        bold: True
                        font_size: 20

                    Label:
                        id: auto_center_frame_position
                        text: 'Null'
                        bold: True
                        font_size: 20

                GridLayout:
                    cols: 2
                    size_hint_y: None
                    height: '30dp'

                    Label:
                        text: 'Error Center'
                        bold: True
                        font_size: 20

                    Label:
                        id: auto_error_center
                        text: 'Null'
                        bold: True
                        font_size: 20

                GridLayout:
                    cols: 2
                    size_hint_y: None
                    height: '30dp'

                    Label:
                        text: 'Bounding Frame'
                        bold: True
                        font_size: 20

                    Label:
                        id: auto_bounding_frame_position
                        text: 'Null'
                        bold: True
                        font_size: 20

                GridLayout:
                    cols: 2
                    size_hint_y: None
                    height: '30dp'

                    Label:
                        text: 'Using Crop'
                        bold: True
                        font_size: 20

                    Label:
                        id: using_crop_value_status
                        text: "Using Crop: Off"
                        bold: True
                        font_size: 20
            
            ### helio stats and camera selectiom ###
            GridLayout:
                rows: 2
                size_hint_x: .23
                Label:
                    id: selected_label_camera
                    text: "None"
                Spinner:
                    id: spinner_camera
                    text: 'Select Camera'
                    size_hint: None, None
                    size: 200, 44
                    pos_hint: {'center_x': 0.5}
                    on_text: root.select_drop_down_menu_camera(self, self.text)
            
            GridLayout:
                rows: 2
                size_hint_x: .23
                Label:
                    id: selected_label_helio_stats
                    text: "None"
                Spinner:
                    id: spinner_helio_stats
                    text: 'Select helio'
                    size_hint: None, None
                    size: 200, 44
                    pos_hint: {'center_x': 0.5}
                    on_text: root.select_drop_down_menu_helio_stats(self, self.text)

            ### Right side: Control buttons __recheck_perspective_transform
            GridLayout:
                cols: 3
                spacing: 10
                Button:
                    text: 'Reset Crop'
                    on_press: root.reset_crop_value()
                    background_color: (.4, .4, .4, 1)

                Button:
                    text: "Save Crop"
                    on_press: root.save_crop_value_image()
                    background_color: (.4, .4, .4, 1)

                Button:
                    text: 'Crop Mode'
                    on_press: root.active_crop_value()
                    background_color: (.4, .4, .4, 1)

            ControllerAuto:
                id: controller_auto
                status_auto: auto_camera_status
                center_frame_auto: auto_center_frame_position
                center_target_auto: auto_center_target_position
                helio_stats_id: selected_label_helio_stats
                camera_url_id: selected_label_camera
                number_center_light: number_of_center_light_detected
                bounding_box_frame_data: auto_bounding_frame_position
                

<ControllerAuto>:
    orientation: 'vertical'
    # Label:
    #     id: return_value
    #     text: "Return: "
    #     bold: True
    #     size_hint_y: .2
    # Button:
    #     text: "debug"
    #     on_press:  root.haddle_extact_boarding_frame()
    Button:
        id: label_auto_mode
        text: 'Auto off'
        on_press: root.active_auto_mode()
        BlinkSpot:
            auto_text: self.parent.text
            size: 50, 50  
            pos: self.parent.x + 200, self.parent.center_y - self.height / 2
            canvas:
                Color:
                    rgba: 1, 0, 0, self.opacity  # Red color with variable opacity
                Ellipse:
                    pos: self.pos
                    size: self.size


<ListHelioStatsIp>:
    viewclass: 'Label'
    RecycleBoxLayout:
        default_size: None, dp(56)
        default_size_hint: 1, None
        size_hint_y: None
        height: self.minimum_height
        orientation: 'vertical'

<ListCameraIp>:
    viewclass: 'Label'
    RecycleBoxLayout:
        default_size: None, dp(56)
        default_size_hint: 1, None
        size_hint_y: None
        height: self.minimum_height
        orientation: 'vertical'

<Description>:
    BoxLayout:
        orientation: 'vertical'
        padding: dp(10)
        spacing: dp(10)
        GridLayout:
            cols: 2
            row_default_height: self.minimum_height
            row_force_default: False
            spacing: dp(10)
            BoxLayout:
                orientation: 'vertical'
                Label:
                    text: "Helio Stats IP"
                    size_hint_y: None
                    height: self.texture_size[1]
                Button:
                    text: 'Reload'
                    size_hint_y: None
                    height: dp(40)
                    on_press: helio_list.reload()
                ListHelioStatsIp:
                    id: helio_list
            BoxLayout:
                orientation: 'vertical'
                Label:
                    text: "Camera IP"
                    size_hint_y: None
                    height: self.texture_size[1]
                Button:
                    text: 'Reload'
                    size_hint_y: None
                    height: dp(40)
                    on_press: camera_list.reload()
                ListCameraIp:
                    id: camera_list
        BoxLayout:
            orientation: 'vertical'
            Label:
                text: 'Reset storage result CSV file.'
            Button:
                text: 'REST'
                
<UploadConnectionPage>:
    BoxLayout:
        orientation: 'vertical'
        Label:
            text: 'Syntax for adding Helio stats and camera ip'
        Image:
            source: './images/connection_array.png'

    ## select connection file ##
    BoxLayout:
        orientation: 'vertical'
        padding: 10
        spacing: 10
        Label:
            text: 'Upload and Display JSON File'
            font_size: '20sp'
            size_hint_y: None
            height: '40dp'
        Button:
            text: 'Select JSON File'
            size_hint_y: None
            height: '50dp'
            on_release: root.open_file_dialog()
        ScrollView:
            GridLayout:
                id: json_display
                cols: 1
                size_hint_y: None
                height: self.minimum_height
                padding: 10
                spacing: 10

<LabHeaderWidget>:
    orientation: 'vertical'
    BoxLayout:
        size_hint_y: None
        height: 100
        canvas.before:
            Color: 
                rgba: (.3,.3,.3,1)
            Rectangle: 
                pos:self.pos
                size:self.size
        Button:
            text: "Manual"
            on_press: root.ids.screen_manager.current = 'manual'
        Button:
            text: "Auto mode"
            on_press: root.ids.screen_manager.current = 'auto'
        Button:
            text: "Description"
            on_press: root.ids.screen_manager.current = 'description'
        Button:
            text: "Connection upload"
            on_press: root.ids.screen_manager.current = 'upload_connection'

    ScreenManager:
        id: screen_manager
        ManualScreen:
            name: 'manual'
        SetAutoScreen:
            name: 'auto'
        Description:
            name: 'description'
        UploadConnectionPage:
            name: 'upload_connection'


